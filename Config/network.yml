AWSTemplateFormatVersion: '2010-09-09'

Parameters:
  ProjectName:
    Type: String
    Description: Project name for cost allocation.
    Default: SecureNoteManager
  Environment:
    Type: String
    Description: Environment name for cost allocation.
    Default: Dev
  UISecurityGroup:
    Type: String
    Description: The ID of the security group for the UI.
  APISecurityGroup:
    Type: String
    Description: The ID of the security group for the API.

Resources:
  # NETWORKS
  MyVPC:
    Type: 'AWS::EC2::VPC'
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: ProjectName
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-vpc'

  ECSClusterSubnetA:
    Type: 'AWS::EC2::Subnet'
    Properties:
      CidrBlock: 10.0.1.0/24
      VpcId: !Ref MyVPC
      AvailabilityZone: us-east-1a
      Tags:
        - Key: ProjectName
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  ECSClusterSubnetB:
    Type: 'AWS::EC2::Subnet'
    Properties:
      CidrBlock: 10.0.2.0/24
      VpcId: !Ref MyVPC
      AvailabilityZone: us-east-1b
      Tags:
        - Key: ProjectName
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # NETWORK LOAD BALANCERS
  UIServiceNetworkLoadBalancer:
    Type: 'AWS::ElasticLoadBalancingV2::LoadBalancer'
    Properties:
      Name: !Sub '${ProjectName}-${Environment}-ui-nlb'
      Scheme: internal
      Subnets:
        - !Ref ECSClusterSubnetA
        - !Ref ECSClusterSubnetB
      SecurityGroups:
        - !Ref UISecurityGroup
      Tags:
        - Key: ProjectName
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
  
  APIServiceNetworkLoadBalancer:
    Type: 'AWS::ElasticLoadBalancingV2::LoadBalancer'
    Properties:
      Name: !Sub '${ProjectName}-${Environment}-api-nlb'
      Scheme: internal
      Subnets:
        - !Ref ECSClusterSubnetA
        - !Ref ECSClusterSubnetB
      SecurityGroups:
        - !Ref APISecurityGroup
      Tags:
        - Key: ProjectName
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  # ELASTIC IPS
  PostgresElasticIP:
    Type: 'AWS::EC2::EIP'
    Properties:
      Domain: vpc
      Tags:
        - Key: ProjectName
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment
          
  NginxElasticIP:
    Type: 'AWS::EC2::EIP'
    Properties:
      Domain: vpc
      Tags:
        - Key: ProjectName
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  UIElasticIP:
    Type: 'AWS::EC2::EIP'
    Properties:
      Domain: vpc
      Tags:
        - Key: ProjectName
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  APIElasticIP:
    Type: 'AWS::EC2::EIP'
    Properties:
      Domain: vpc
      Tags:
        - Key: ProjectName
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

Outputs:
  VPCId:
    Description: VPC ID
    Value: !GetAtt MyVPC.VpcId
    Export:
      Name: !Sub '${ProjectName}-${Environment}-vpc-id'
  ECSClusterSubnetA:
    Description: Subnet ID for the ECS cluster
    Value: !GetAtt ECSClusterSubnetA.SubnetId
    Export:
      Name: !Sub '${ProjectName}-${Environment}-ecs-cluster-subneta-id'
  ECSClusterSubnetB:
    Description: Subnet ID for the ECS cluster
    Value: !GetAtt ECSClusterSubnetA.SubnetId
    Export:
      Name: !Sub '${ProjectName}-${Environment}-ecs-cluster-subnetb-id'
  PostgresElasticIP:
    Description: Elastic IP for the Postgres EC2 instance
    Value: !GetAtt PostgresElasticIP.AllocationId
    Export:
      Name: !Sub '${ProjectName}-${Environment}-postgres-elastic-ip'
  NginxElasticIP:
    Description: Elastic IP for the Nginx EC2 instance
    Value: !GetAtt NginxElasticIP.AllocationId
    Export:
      Name: !Sub '${ProjectName}-${Environment}-nginx-elastic-ip'
  UIElasticIP:
    Description: Elastic IP for the UI ECS service
    Value: !GetAtt UIElasticIP.AllocationId
    Export:
      Name: !Sub '${ProjectName}-${Environment}-ui-elastic-ip'
  APIElasticIP:
    Description: Elastic IP for the API ECS service
    Value: !GetAtt APIElasticIP.AllocationId
    Export:
      Name: !Sub '${ProjectName}-${Environment}-api-elastic-ip'
  UIServiceNetworkLoadBalancer:
    Description: Network load balancer for the UI
    Value: !GetAtt UIServiceNetworkLoadBalancer.Arn
    Export:
      Name: !Sub '${ProjectName}-${Environment}-ui-nlb'
  APIServiceNetworkLoadBalancer:
    Description: Network load balancer for the API
    Value: !GetAtt APIServiceNetworkLoadBalancer.Arn
    Export:
      Name: !Sub '${ProjectName}-${Environment}-api-nlb'