AWSTemplateFormatVersion: '2010-09-09'

Parameters:
  VpcId:
    Type: String
    Description: The ID of the VPC where security groups will be created.
  IngressCIDR:
    Type: String
    Description: The CIDR range allowed to access the application.
    Default: 0.0.0.0/0
  ProjectName:
    Type: String
    Description: The project name for cost allocation.
    Default: SecureNoteManager
  Environment:
    Type: String
    Description: The environment for cost allocation.
    Default: Development

Resources:
  DatabaseSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      VpcId: !Ref VpcId
      GroupDescription: Security group for the PostgreSQL database
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !GetAtt APISecurityGroup.GroupId
      Tags:
        - Key: ProjectName
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  ReverseProxySecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      VpcId: !Ref VpcId
      GroupDescription: Security group for the Nginx reverse proxy
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: !Ref IngressCIDR
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: !Ref IngressCIDR
      Tags:
        - Key: ProjectName
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  APISecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      VpcId: !Ref VpcId
      GroupDescription: Security group for the API
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5000
          ToPort: 5000
          SourceSecurityGroupId: !GetAtt UISecurityGroup.GroupId
        - IpProtocol: tcp
          FromPort: 5000
          ToPort: 5000
          SourceSecurityGroupId: !GetAtt ReverseProxySecurityGroup.GroupId
      Tags:
        - Key: ProjectName
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

  UISecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      VpcId: !Ref VpcId
      GroupDescription: Security group for the UI
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          SourceSecurityGroupId: !GetAtt ReverseProxySecurityGroup.GroupId
      Tags:
        - Key: ProjectName
          Value: !Ref ProjectName
        - Key: Environment
          Value: !Ref Environment

Outputs:
  DatabaseSecurityGroup:
    Description: Security group ID for the PostgreSQL database
    Value: !GetAtt DatabaseSecurityGroup.GroupId
    Export:
      Name: !Sub '${ProjectName}-${Environment}-database-security-group-id'
  ReverseProxySecurityGroup:
    Description: Security group ID for the Nginx reverse proxy
    Value: !GetAtt ReverseProxySecurityGroup.GroupId
    Export:
      Name: !Sub '${ProjectName}-${Environment}-reverse-proxy-security-group-id'
  APISecurityGroup:
    Description: Security group ID for the API
    Value: !GetAtt APISecurityGroup.GroupId
    Export:
      Name: !Sub '${ProjectName}-${Environment}-api-security-group-id'
  UISecurityGroup:
    Description: Security group ID for the UI
    Value: !GetAtt UISecurityGroup.GroupId
    Export:
      Name: !Sub '${ProjectName}-${Environment}-ui-security-group-id'